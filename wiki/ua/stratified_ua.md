# Опис роботи скрипта

Цей скрипт реалізує техніку **Стратифікованої вибірки**, де записи відбираються з набору даних на основі їхнього групування в страти (або категорії). Мета полягає в тому, щоб забезпечити, що вибірка відображає пропорції цих страт у загальній популяції.

## Як це працює:

### Підготовка даних:
- Створюється копія вихідного набору даних, щоб запобігти будь-яким змінам в оригінальних даних.
- До набору даних додається новий стовпець `is_sample`, де спочатку всі записи позначаються як невибрані (`0`).

### Групування за стратами:
- Популяція ділиться на страти на основі значень у заданому стовпці (наприклад, категорії або типу).
- Кожна група (страта) обробляється окремо для того, щоб вибірка відображала пропорцію кожної групи в загальній популяції.

### Визначення кількості записів, які вибрати з кожної страти:
- Для кожної групи (страти) розраховується кількість записів, які необхідно вибрати, на основі пропорції страти в популяції. Наприклад, якщо страта становить 20% популяції, 20% від загального розміру вибірки буде відібрано з цієї страти.
- Розрахований розмір вибірки округлюється, що може спричинити незначні відхилення від ідеальних пропорцій.

### Відбір записів із кожної страти:
- Записи випадково відбираються з кожної страти, щоб кількість відібраних записів відповідала розрахованому розміру вибірки для цієї групи.
- Якщо страта містить менше записів, ніж розрахований розмір вибірки, будуть відібрані всі доступні записи з цієї страти.

### Коригування розміру вибірки:
- Якщо загальний розмір вибірки менший за запитуваний після початкового відбору, додаткові записи випадково відбираються з найбільшої страти, поки розмір вибірки не відповідатиме запитуваному.
- Пропорції коригуються відповідно під час цього процесу.

### Формування фінальної вибірки:
- Записи, вибрані з усіх страт, об'єднуються в одну підсумкову вибірку.
- Стовпець `is_sample` в оригінальній популяції оновлюється для позначення, які записи були вибрані (`1` для вибраних записів).

### Звіт про виконання:
- Скрипт генерує підсумковий опис процесу вибірки, включаючи інформацію про загальний розмір популяції, розмір вибірки, стовпець, за яким було проведено стратифікацію, та час виконання вибірки.

---

## Важливі моменти:

- **Пропорційність вибірки**: Скрипт забезпечує, що кожна група (страта) представлена у вибірці відповідно до її частки в популяції.
- **Випадковий відбір усередині страт**: Для кожної групи скрипт випадково відбирає записи, забезпечуючи, що вибірка відображає початковий розподіл.
- **Коригування після округлення**: Якщо кількість записів у вибірці відрізняється від запитуваного розміру через округлення, додаткові записи відбираються з найбільшої групи, щоб забезпечити правильний розмір вибірки.

---

## Коли пропорції можуть відхилятися:

- **Округлення**: Через округлення кількість відібраних записів для кожної групи може дещо відрізнятися від ідеально пропорційного розподілу.
- **Коригування**: Якщо після округлення загальна кількість записів менша або більша за запитувану, відбираються додаткові записи з найбільшої групи, що може трохи змінити пропорції.
- **Малі групи**: Якщо група містить менше записів, ніж розрахований розмір вибірки, всі доступні записи з цієї групи включаються, що також може вплинути на пропорційність.

---

## На завершення:

- Цей скрипт гарантує, що вибірка відображає розподіл записів серед різних страт у популяції. Розмір вибірки коригується відповідно до запиту, зберігаючи пропорційність вихідних даних наскільки це можливо.
