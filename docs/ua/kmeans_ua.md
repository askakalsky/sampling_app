# Опис роботи скрипта

Цей скрипт виконує **вибірку на основі кластеризації методом K-Means** з оптимізацією гіперпараметрів за допомогою **Optuna**. Вибірка ґрунтується на відстані записів до центроїдів кластерів, де відбираються найбільш "віддалені" записи, що вважаються аномальними або найкраще репрезентативними для свого кластеру. При цьому враховується різна густина кластерів, щоб забезпечити рівномірний відбір аномалій з кожного кластера.

## Як працює метод K-Means

### Основи алгоритму K-Means
- **K-Means** — це метод кластеризації, який розбиває дані на **k кластерів** на основі схожості між точками. Алгоритм ітеративно оновлює позиції центроїдів кластерів, щоб мінімізувати відстань між точками і їхніми центроїдами.
- Після завершення кластеризації кожна точка належить до кластера з найближчим центроїдом.
- **Гіперпараметри** (такі як кількість кластерів, кількість ініціалізацій та максимальна кількість ітерацій) можуть впливати на якість кластеризації, тому вони оптимізуються за допомогою **Optuna**.

### Як це працює

#### Підготовка даних
- Створюються копії оригінального та підготовленого наборів даних, щоб уникнути змін у вихідних даних.
- До набору даних додаються стовпці для зберігання відстаней до центроїдів та номерів кластерів.

#### Оптимізація гіперпараметрів K-Means
- За допомогою бібліотеки **Optuna** виконується оптимізація гіперпараметрів K-Means, таких як кількість кластерів (`n_clusters`), кількість ініціалізацій (`n_init`) та максимальна кількість ітерацій (`max_iter`).
- Оптимізація базується на оцінці якості кластеризації за допомогою метрики **Calinski-Harabasz**, яка вимірює щільність та відокремленість кластерів.

#### Відбір аномалій
- Після оптимізації виконується кластеризація, і для кожного запису обчислюється відстань до центроїда його кластера.
- Для формування вибірки аномалій виконується рівномірний відбір найбільш "віддалених" записів з кожного кластера. Це дозволяє врахувати різну густину кластерів та уникнути переваги кластерів з меншою щільністю.
  - **Кількість аномалій на кластер** може бути задана явно через параметр `anomalies_per_cluster`. Якщо цей параметр не заданий, вибірка розподіляється рівномірно між кластерами пропорційно їх кількості.
  - Якщо загальна кількість вибраних аномалій перевищує запитаний розмір вибірки, кількість аномалій на кластер коригується відповідно.

#### Формування вибірки
- Відібрані записи додаються у фінальну вибірку, і ці записи позначаються у стовпці `is_sample`.
- Якщо запитаний розмір вибірки перевищує кількість записів, виводиться попередження, і використовується вся популяція.

#### Звіт про виконання
- Формується підсумковий звіт про виконану вибірку, який включає кількість кластерів, параметри моделі, дату та час виконання, розмір вибірки та гіперпараметри, які були оптимізовані.

---

## Важливі моменти

- **Оптимізація за допомогою Optuna**: Гіперпараметри K-Means оптимізуються за допомогою Optuna для покращення якості кластеризації.
- **Відбір аномалій рівномірно з кластерів**: Записи відбираються на основі їхньої відстані до центроїдів, забезпечуючи рівномірний відбір аномалій з кожного кластеру, незалежно від його густини.
- **Можливість відтворення**: Використання випадкового зерна (`random_seed`) забезпечує можливість відтворення результатів кластеризації та вибірки.
- **Гнучкість вибірки**: Можливість задати конкретну кількість аномалій на кластер (`anomalies_per_cluster`) або автоматичний розподіл вибірки між кластерами.

---

## Можливі відхилення

- **Мала кількість кластерів**: Якщо кількість кластерів занадто мала, це може призвести до поганої кластеризації, що вплине на якість вибірки аномалій.
- **Недостатня кількість аномалій у кластері**: У кластерах з дуже малою кількістю записів може бути складно вибрати необхідну кількість аномалій. В такому випадку можна встановити мінімальну або максимальну кількість аномалій на кластер.
- **Великі відстані можуть не бути ідеальними**: Вибірка на основі найбільших відстаней може не завжди відповідати меті вибірки для кожного конкретного випадку, особливо якщо в даних присутні шумові точки.

---

## На завершення

Цей скрипт використовує кластеризацію методом **K-Means** з оптимізацією гіперпараметрів за допомогою **Optuna**. Вибірка аномалій заснована на відстанях до центроїдів кластерів з урахуванням густини кластерів, що допомагає виділити найбільш репрезентативні або аномальні записи рівномірно з усіх кластерів.