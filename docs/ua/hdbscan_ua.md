# Опис роботи скрипта

Цей скрипт виконує **вибірку на основі аномалій** за допомогою кластеризації **HDBSCAN** з оптимізацією гіперпараметрів через **Optuna**. Алгоритм кластеризує дані, виявляє аномалії та повертає вибірку з аномальних записів. **ВАЖЛИВО** Для забезпечення швидкої роботи усіх модулей програми, для данного алгоритму введено обмеження, щодо використання на датасетах, що містять більше 300 000 записів.


## Як працює HDBSCAN:

### Основи алгоритму HDBSCAN:
- **HDBSCAN (Hierarchical Density-Based Spatial Clustering of Applications with Noise)** — це алгоритм кластеризації, який не потребує фіксованої кількості кластерів. Він групує дані на основі щільності та визначає аномалії як ті записи, що не належать жодному кластеру.
- Алгоритм HDBSCAN працює за принципом оцінки щільності даних у різних масштабах і використовує дендрограму для побудови кластерів. Записи, які не входять до жодного кластера, позначаються як аномалії.

### Як це працює:

### Підготовка даних:
- Створюються копії оригінального та підготовленого наборів даних для уникнення змін у вихідних даних.
- Додаються стовпці для зберігання кластерної інформації та позначок аномалій.

### Оптимізація гіперпараметрів за допомогою Optuna:
- За допомогою **Optuna** проводиться оптимізація гіперпараметрів HDBSCAN для максимізації **силуетного індексу**, який оцінює якість кластеризації.
- Гіперпараметри, такі як мінімальний розмір кластера та кількість зразків, підбираються автоматично.

### Виявлення аномалій:
- Після оптимізації виконується кластеризація даних, де записи, що не входять до жодного кластера, вважаються аномаліями (позначені як -1).
- Додаються стовпці для зберігання інформації про кластер та позначки аномалій.

### Відбір вибірки:
- Аномальні записи вибираються на основі запитаної кількості. Якщо кількість виявлених аномалій менша, ніж запитаний розмір вибірки, всі аномалії включаються до вибірки.

### Формування вибірки:
- Відібрані аномалії додаються у фінальну вибірку, і ці записи позначаються у стовпці `is_sample`.

### Звіт про виконання:
- Формується підсумковий звіт про виконану вибірку, який включає кількість виявлених аномалій, параметри моделі, розмір вибірки та дату виконання.

---

## Важливі моменти:

- **HDBSCAN з динамічною кластеризацією**: HDBSCAN автоматично визначає кількість кластерів, що дозволяє виявляти структуру даних без потреби фіксованої кількості кластерів.
- **Оптимізація за допомогою Optuna**: Гіперпараметри HDBSCAN підбираються автоматично для досягнення кращої якості кластеризації.
- **Відтворюваність**: Використання випадкового зерна дозволяє відтворювати результати кластеризації та вибірки.

---

## Можливі відхилення:

- **Недостатня кількість аномалій**: Якщо кількість аномалій у популяції менша за запитувану вибірку, можуть бути повернуті всі доступні аномалії, що менше запитаної кількості.
- **Чутливість до параметрів**: Параметри HDBSCAN можуть суттєво впливати на результати кластеризації, тому оптимізація має вирішальне значення.

---

## На завершення:

- Цей скрипт використовує **HDBSCAN** для виявлення аномалій та кластеризації даних. Оптимізація параметрів через **Optuna** забезпечує високу якість кластеризації, дозволяючи виявити структуру даних та найбільш аномальні записи.
